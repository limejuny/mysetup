- name: Check if tfenv is installed
  shell: test -d ~/.tfenv && echo "yes" || echo "no"
  register: is_tfenv_installed

- name: Clone tfenv
  git:
    repo: 'https://github.com/tfutils/tfenv.git'
    dest: ~/.tfenv
  when: is_tfenv_installed.stdout == "no"

- name: Install & Set Terraform Version
  shell: |
      ~/.tfenv/bin/tfenv install {{ terraform_version }}
      ~/.tfenv/bin/tfenv use {{ terraform_version }}
  vars:
    terraform_version: 1.4.2

- name: Clone terraform-lsp
  git:
    repo: 'https://github.com/juliosueiras/terraform-lsp.git'
    dest: ~/.terraform-lsp
    version: v0.0.12

- name: Install terraform-lsp
  shell: |
      cd ~/.terraform-lsp
      PATH=$PATH:/usr/local/go/bin
      GO111MODULE=on go mod download
      make
      mv ~/.terraform-lsp/terraform-lsp ~/bin/terraform-lsp
